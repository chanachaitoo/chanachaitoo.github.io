<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order</title>
    <link rel="icon" type="image/png" href="Black_Hannah.png">
    
    <script>
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://wsrv.nl">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root {
            --bg-body: #f3f4f6;
            --primary: #2563eb;       
            --primary-light: #60a5fa; 
            --primary-dark: #1e40af;  
            --secondary-start: #10b981; 
            --secondary-end: #34d399;   
            --status-pending: #f97316;   
            --status-success: #22c55e;   
            --proc-received: #6b7280;
            --proc-queue: #f97316;
            --proc-working: #2563eb;
            --proc-waiting: #9333ea;
            --proc-done: #22c55e;
            --bg-card: #ffffff;
            --text-main: #374151;
            --text-sub: #6b7280;
        }

        body { 
            font-family: 'Noto Sans Thai', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
        }
        
        .theme-text-primary { color: var(--primary); }
        .theme-bg-primary-gradient { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); }
        .theme-bg-secondary-gradient { background: linear-gradient(135deg, var(--secondary-start), var(--secondary-end)); }
        
        .theme-text-pending { color: var(--status-pending); }
        .theme-bg-pending { background-color: var(--status-pending); }
        .theme-text-success { color: var(--status-success); }
        .theme-bg-success { background-color: var(--status-success); }
        .text-payment-pending { color: #f59e0b; } 
        .text-payment-success { color: #15803d; } 

        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        .skeleton-dark {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>

    <!-- Search Section -->
    <div class="max-w-7xl mx-auto px-4 pt-10 pb-2">
        <div class="max-w-2xl mx-auto mb-2">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400 group-focus-within:text-[var(--primary)] transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <!-- เปลี่ยน Placeholder ตามที่ขอ -->
                <input type="text" id="search-input" 
                    class="block w-full pl-11 pr-4 py-3 border border-gray-200 rounded-full leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-light)] focus:border-transparent transition-all shadow-sm text-gray-700"
                    placeholder="ค้นหาไอดีออเดอร์ ลูกค้า ตัวละคร...">
            </div>
        </div>
    </div>

    <!-- Dashboard Summary -->
    <div class="max-w-7xl mx-auto px-4 py-4 mt-2">
        <div class="grid grid-cols-2 gap-6 mb-8">
            <div class="theme-bg-primary-gradient rounded-3xl p-6 text-white shadow-lg relative overflow-hidden group">
                <div class="relative z-10">
                    <div class="text-xl font-medium opacity-90 mb-1">จำนวนออเดอร์</div>
                    <div id="total-orders" class="text-3xl md:text-4xl font-bold tracking-tight">
                        <div class="h-10 w-24 skeleton rounded-lg mt-1"></div>
                    </div>
                </div>
                <div class="absolute right-[-10px] bottom-[-10px] opacity-20 transform rotate-12 group-hover:scale-110 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                </div>
            </div>
            
            <div class="theme-bg-secondary-gradient rounded-3xl p-6 text-white shadow-lg relative overflow-hidden group">
                <div class="relative z-10">
                    <div class="text-xl font-medium opacity-90 mb-1">จำนวนสินค้า</div>
                    <div id="total-products" class="text-3xl md:text-4xl font-bold tracking-tight">
                        <div class="h-10 w-24 skeleton rounded-lg mt-1"></div>
                    </div>
                </div>
                <div class="absolute right-[-10px] bottom-[-10px] opacity-20 transform rotate-12 group-hover:scale-110 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Column 1: Pending Orders -->
            <div class="bg-white rounded-3xl p-6 shadow-sm min-h-[500px] flex flex-col">
                <div class="flex items-center justify-between mb-4 flex-none">
                    <h2 class="text-lg font-bold flex items-center theme-text-pending">
                        <i class="fas fa-clock mr-2 text-xl"></i>
                        กำลังดำเนินการ
                    </h2>
                    <span id="pending-count-badge" class="bg-orange-100 text-orange-600 text-xs font-bold px-2.5 py-1 rounded-full hidden">
                        0
                    </span>
                </div>
                
                <div id="pending-list" class="space-y-4 flex-1 flex flex-col">
                    <!-- Skeleton Loader -->
                </div>
            </div>

            <!-- Column 2: Completed Orders -->
            <div class="bg-white rounded-3xl p-6 shadow-sm min-h-[500px] flex flex-col">
                <h2 class="text-lg font-bold mb-4 flex items-center theme-text-success flex-none">
                    <i class="fas fa-check-circle mr-2 text-xl"></i>
                    เรียบร้อยแล้ว
                </h2>
                <div id="completed-list" class="space-y-4 flex-1 flex flex-col">
                    <!-- Skeleton Loader -->
                </div>
                
                <!-- Pagination Controls -->
                <div id="pagination-controls" class="hidden flex-none flex justify-center items-center mt-6 pt-4 border-t border-gray-100 gap-4">
                    <button id="prev-btn" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-50 hover:text-[var(--primary)] hover:border-[var(--primary-light)] disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-sm flex items-center justify-center text-xs">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    
                    <span class="text-sm font-medium text-gray-600 w-auto text-center" id="page-info">1 / 1</span>
                    
                    <button id="next-btn" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-50 hover:text-[var(--primary)] hover:border-[var(--primary-light)] disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-sm flex items-center justify-center text-xs">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal (Popup) -->
    <div id="order-modal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-black/50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl transform scale-95 transition-transform duration-300" id="modal-content">
            
            <!-- Modal Header -->
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center flex-none rounded-t-2xl">
                <div>
                    <h3 class="text-xl font-bold text-gray-800" id="m-order-id">เลขที่ออเดอร์</h3>
                    <p class="text-sm text-gray-500" id="m-order-date">วันที่</p>
                </div>
                <div class="flex gap-2">
                    <!-- ปุ่มแคปหน้าจอ -->
                    <button id="capture-btn" class="text-gray-400 hover:text-[var(--primary)] bg-gray-100 p-2 rounded-full transition-colors" title="บันทึกบิล">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <!-- ปุ่มปิด -->
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 bg-gray-100 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div id="modal-body" class="p-6 overflow-y-auto custom-scroll flex-1 overscroll-contain">
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg flex items-center gap-3">
                        <div id="m-game-logo" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex-shrink-0 flex items-center justify-center overflow-hidden">
                             <!-- Logo -->
                        </div>
                        <div class="min-w-0">
                            <span class="block text-gray-400 text-xs uppercase">เกมส์</span>
                            <span class="font-semibold block truncate" id="m-game-id">-</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="block text-gray-400 text-xs uppercase">ไอดีบัญชีลูกค้า</span>
                        <span class="font-semibold block truncate" id="m-customer-id">-</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="block text-gray-400 text-xs uppercase">สถานะการชำระเงิน</span>
                        <span class="font-semibold block truncate" id="m-payment">-</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="block text-gray-400 text-xs uppercase">ราคารวม</span>
                        <span class="font-semibold theme-text-primary block truncate" id="m-price">-</span>
                    </div>
                </div>

                <h4 class="font-bold mb-3 border-l-4 pl-3" style="border-color: var(--primary);">รายการสินค้า</h4>
                <div id="m-product-list" class="space-y-4 pb-2">
                    <!-- Product Items -->
                </div>
            </div>
        </div>
    </div>

    <!-- Container สำหรับแคปภาพ (ซ่อนอยู่) -->
    <div id="capture-container" style="position: absolute; top: -9999px; left: -9999px; width: 500px; background: #fff;"></div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-2 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        <span id="toast-message">แจ้งเตือน</span>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwygcJWfjcLXn3IB7QV4fmD0xSMSqfICob-TfkkEDcZlawkq1Z1qWqvGGiMIjOxL7jv/exec'; 

        // GAME DATA Helper
        const GAME_DATA = {
            "Game001": { name: "Chibi Planet", logo: "https://scontent.fnak3-1.fna.fbcdn.net/v/t39.30808-6/454034457_888216613326832_350146185151871213_n.jpg?_nc_cat=100&cb2=99be929b-a592a72f&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=wS2bwUNomx8Q7kNvwFLSCWl&_nc_oc=AdlNYCDS2RinC6SOd1IhPsxFeMvpIcgn-0n6F2U-jpj8QX3RaWFU9BrV_nMcXekYPjA&_nc_zt=23&_nc_ht=scontent.fnak3-1.fna&_nc_gid=OMljTASTpY8KftyJ7As4jA&oh=00_Afhs8hqzCIRB9sLnV0ahGCZw5VkBN231cRHg54VsPPFHCQ&oe=6931B63F" },
            "Game002": { name: "Zabb World", logo: "https://scontent.fnak3-1.fna.fbcdn.net/v/t39.30808-6/481112265_1236524098476464_4209232438207953182_n.jpg?_nc_cat=100&cb2=99be929b-a592a72f&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=2mCNyArRQUUQ7kNvwFvA7s4&_nc_oc=Adl5ZjHBoXGw7-g8e9Jq7a5I6DgnDC2Bu8syocL1re9jNIPkcy6LHOSffXIxB50KHZ4&_nc_zt=23&_nc_ht=scontent.fnak3-1.fna&_nc_gid=beyM7XhPrUzXtG0IiIiVXA&oh=00_AfhxjYMUMvjDjc00qjdvnJ1MCftZEY0mop2Kexk-Hasytw&oe=6931C25C" }
        };

        let allOrders = [];
        let filteredOrdersList = []; 
        let completedOrdersList = []; 
        let currentPage = 1;
        const itemsPerPage = 5;

        // เก็บข้อมูลออเดอร์ที่กำลังเปิดอยู่ เพื่อใช้สร้างบิล
        let currentOpenOrder = null;

        const searchInput = document.getElementById('search-input');

        function getGameInfo(gameId) {
            if (GAME_DATA[gameId]) {
                return GAME_DATA[gameId];
            }
            return { name: gameId || '-', logo: null };
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('translate-y-20');
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 5000);
        }

        function renderSkeletonLoader() {
            const pendingList = document.getElementById('pending-list');
            const completedList = document.getElementById('completed-list');
            
            const skeletonHTML = `
                <div class="bg-white border border-gray-100 rounded-2xl p-4 mb-4 flex-none">
                    <div class="flex justify-between mb-2">
                        <div class="h-4 w-24 skeleton-dark"></div>
                        <div class="h-3 w-3 rounded-full skeleton-dark"></div>
                    </div>
                    <div class="h-6 w-32 skeleton-dark mb-2"></div>
                    <div class="h-4 w-20 skeleton-dark mt-2"></div>
                </div>
            `;
            pendingList.innerHTML = skeletonHTML.repeat(3);
            completedList.innerHTML = skeletonHTML.repeat(3);
        }

        async function fetchData() {
            renderSkeletonLoader();
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                allOrders = data;
                processOrders();
                
            } catch (error) {
                console.warn('API Error:', error);
                showToast('ไม่สามารถดึงข้อมูลได้ โปรดลองใหม่อีกครั้ง');
                allOrders = [];
                processOrders();
            }
        }

        function processOrders(filterText = '') {
            const searchText = filterText.toLowerCase().trim();
            
            if (!searchText) {
                filteredOrdersList = [...allOrders];
            } else {
                filteredOrdersList = allOrders.filter(order => {
                    const orderId = (order.order_id || '').toLowerCase();
                    const customerId = (order.customer_account_id || '').toLowerCase();
                    
                    const hasCharacterId = order.items && order.items.some(item => 
                        (item.customer_game_id || '').toLowerCase().includes(searchText)
                    );

                    return orderId.includes(searchText) || 
                           customerId.includes(searchText) || 
                           hasCharacterId;
                });
            }

            filteredOrdersList.sort((a, b) => {
                const numA = parseInt(a.order_id.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.order_id.replace(/\D/g, '')) || 0;
                return numB - numA;
            });

            renderDashboard();
        }

        function formatDate(dateString) {
            if(!dateString) return "-";
            const date = new Date(dateString);
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const day = date.getDate();
            const month = months[date.getMonth()];
            let year = date.getFullYear();
            if (year < 2400) year += 543;
            return `${day} ${month} ${year}`;
        }

        function formatNumber(num) {
            const val = parseFloat(num);
            if (Number.isInteger(val)) {
                return val.toLocaleString('th-TH', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
            }
            return val.toLocaleString('th-TH', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        function getDriveDirectLink(url) {
            if (!url) return '';
            let id = '';
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                const parts = url.split('/');
                const dIndex = parts.indexOf('d');
                if (dIndex !== -1 && parts[dIndex + 1]) {
                    id = parts[dIndex + 1];
                } else {
                    try {
                        const urlObj = new URL(url);
                        id = urlObj.searchParams.get('id');
                    } catch(e) {
                        const match = url.match(/id=([a-zA-Z0-9_-]+)/);
                        if (match) id = match[1];
                    }
                }
            }
            if (id) {
                const googleExportUrl = `https://drive.google.com/uc?id=${id}`;
                return `https://wsrv.nl/?url=${encodeURIComponent(googleExportUrl)}&w=200&h=200&fit=cover&output=webp&q=75`;
            }
            return url;
        }

        function renderDashboard() {
            const pendingList = document.getElementById('pending-list');
            const completedList = document.getElementById('completed-list');
            
            pendingList.innerHTML = '';
            completedList.innerHTML = '';

            let totalProducts = 0;
            let pendingOrders = [];
            completedOrdersList = []; 

            if (filteredOrdersList.length === 0) {
                const emptyMsg = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-search mb-2 text-2xl opacity-50"></i>
                        <p>ไม่พบข้อมูลที่ค้นหา</p>
                    </div>
                `;
                pendingList.innerHTML = emptyMsg;
                completedList.innerHTML = emptyMsg;
            }

            filteredOrdersList.forEach(order => {
                totalProducts += order.items ? order.items.length : 0;
                if (order.is_completed) {
                    completedOrdersList.push(order);
                } else {
                    pendingOrders.push(order);
                }
            });

            document.getElementById('total-orders').innerText = formatNumber(filteredOrdersList.length).split('.')[0];
            document.getElementById('total-products').innerText = formatNumber(totalProducts).split('.')[0];

            const pendingBadge = document.getElementById('pending-count-badge');
            if (pendingOrders.length > 0) {
                pendingBadge.innerText = pendingOrders.length;
                pendingBadge.classList.remove('hidden');
            } else {
                pendingBadge.classList.add('hidden');
            }

            if (pendingOrders.length === 0 && filteredOrdersList.length > 0) {
                pendingList.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-clipboard-check mb-2 text-2xl opacity-50"></i>
                        <p>ไม่มีรายการที่กำลังดำเนินการ</p>
                    </div>
                `;
            } else {
                pendingOrders.forEach(order => {
                    const card = createCard(order);
                    pendingList.appendChild(card);
                });
            }

            renderCompletedOrdersPage();
        }

        function renderCompletedOrdersPage() {
            const completedList = document.getElementById('completed-list');
            completedList.innerHTML = '';

            if (completedOrdersList.length === 0) {
                if (filteredOrdersList.length > 0) {
                     completedList.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-400">
                            <i class="fas fa-history mb-2 text-2xl opacity-50"></i>
                            <p>ไม่มีรายการที่สำเร็จแล้ว</p>
                        </div>
                     `;
                }
                togglePagination(false);
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = completedOrdersList.slice(startIndex, endIndex);

            pageItems.forEach(order => {
                const card = createCard(order);
                completedList.appendChild(card);
            });

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(completedOrdersList.length / itemsPerPage);
            const controls = document.getElementById('pagination-controls');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInfo = document.getElementById('page-info');

            if (totalPages <= 1) {
                controls.classList.add('hidden');
            } else {
                controls.classList.remove('hidden');
                pageInfo.innerText = `${currentPage} / ${totalPages}`;
                
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            }
        }

        function togglePagination(show) {
            const controls = document.getElementById('pagination-controls');
            if (show) controls.classList.remove('hidden');
            else controls.classList.add('hidden');
        }

        function createCard(order) {
            const card = document.createElement('div');
            card.className = "flex-none bg-white border border-gray-100 rounded-2xl p-4 cursor-pointer transition-all duration-200 group hover:shadow-md hover:border-blue-100";
            card.addEventListener('click', () => openModal(order));

            const isPending = !order.is_completed;
            const statusClass = isPending ? 'theme-bg-pending' : 'theme-bg-success';
            
            const priceDisplay = order.net_price ? formatNumber(order.net_price) : '0';
            const itemCount = order.items ? order.items.length : 0;

            const gameInfo = getGameInfo(order.game_id);
            const gameLogoHtml = gameInfo.logo 
                ? `<img src="${gameInfo.logo}" class="w-6 h-6 rounded-full object-cover border border-gray-200" alt="${gameInfo.name}">`
                : `<svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path></svg>`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="text-xs text-gray-400 block mb-1">${formatDate(order.order_date)}</span>
                        <h3 class="font-bold text-gray-800 text-lg transition-colors group-hover:text-[var(--primary)]">
                            ${order.order_id}
                        </h3>
                    </div>
                    <div class="${statusClass} w-2 h-2 rounded-full mt-2"></div>
                </div>
                <div class="flex items-center text-sm text-gray-500 gap-2 mt-2">
                    ${gameLogoHtml}
                    <span class="font-medium">${gameInfo.name}</span>
                </div>
                <div class="mt-3 flex justify-between items-end border-t border-gray-200 pt-2">
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded-full text-gray-600">${itemCount} รายการ</span>
                        <span class="font-semibold text-gray-700">${priceDisplay} บาท</span>
                </div>
            `;
            return card;
        }

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderCompletedOrdersPage();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            const totalPages = Math.ceil(completedOrdersList.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderCompletedOrdersPage();
            }
        });

        searchInput.addEventListener('input', (e) => {
            currentPage = 1; 
            processOrders(e.target.value);
        });

        function getStatusStyle(status) {
            const s = (status || "").trim();
            if (s === "รับเข้า" || s === "Received") {
                return "bg-gray-100 text-gray-600 border-gray-200"; 
            } else if (s === "รอคิว" || s === "Queue") {
                return "bg-orange-100 text-orange-600 border-orange-200"; 
            } else if (s === "เริ่มงาน" || s === "In Progress" || s === "กำลังดำเนินการ" || s === "กำลังเติม") {
                return "bg-blue-100 text-blue-600 border-blue-200"; 
            } else if (s === "รอส่ง" || s === "Waiting") {
                return "bg-purple-100 text-purple-600 border-purple-200"; 
            } else if (s === "เรียบร้อยแล้ว" || s === "Completed") {
                return "bg-green-100 text-green-600 border-green-200"; 
            } else {
                return "bg-gray-100 text-gray-500 border-gray-200"; 
            }
        }

        const modal = document.getElementById('order-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const captureBtn = document.getElementById('capture-btn');

        function openModal(order) {
            document.body.style.overflow = 'hidden';
            
            // Store current order for capturing
            currentOpenOrder = order;

            document.getElementById('m-order-id').innerText = order.order_id;
            document.getElementById('m-order-date').innerText = formatDate(order.order_date);
            
            const gameInfo = getGameInfo(order.game_id);
            document.getElementById('m-game-id').innerText = gameInfo.name;
            
            const logoContainer = document.getElementById('m-game-logo');
            if (gameInfo.logo) {
                logoContainer.innerHTML = `<img src="${gameInfo.logo}" class="w-full h-full object-cover">`;
                logoContainer.classList.remove('hidden');
            } else {
                 logoContainer.innerHTML = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path></svg>`;
            }

            document.getElementById('m-customer-id').innerText = order.customer_account_id || '-';
            
            const payEl = document.getElementById('m-payment');
            payEl.innerText = order.payment_status || 'Pending';
            
            let payColorClass = 'text-gray-500';
            if (order.payment_status === 'รอชำระ') {
                payColorClass = 'text-payment-pending';
            } else if (order.payment_status === 'ชำระเงินเรียบร้อย' || order.payment_status === 'Paid') {
                payColorClass = 'text-payment-success';
            }
            payEl.className = `font-semibold block truncate ${payColorClass}`;
            
            document.getElementById('m-price').innerText = (order.net_price ? formatNumber(order.net_price) : '0') + ' บาท';

            const productList = document.getElementById('m-product-list');
            productList.innerHTML = '';
            
            if (order.items && order.items.length > 0) {
                const sortedItems = [...order.items].sort((a, b) => {
                    const isDoneA = a.process_status === 'เรียบร้อยแล้ว' || a.process_status === 'Completed';
                    const isDoneB = b.process_status === 'เรียบร้อยแล้ว' || b.process_status === 'Completed';
                    return (isDoneA === isDoneB) ? 0 : isDoneA ? 1 : -1;
                });

                sortedItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "flex gap-4 p-3 bg-white border border-gray-100 rounded-xl shadow-sm items-center";
                    
                    const statusClass = getStatusStyle(item.process_status);

                    const rawImgUrl = item.image_link;
                    const displayImgUrl = getDriveDirectLink(rawImgUrl);

                    const imgHtml = displayImgUrl 
                        ? `<div class="relative w-16 h-16 flex-none">
                             <div class="absolute inset-0 skeleton-dark rounded-lg"></div>
                             <img src="${displayImgUrl}" class="w-full h-full object-cover rounded-lg relative z-10 opacity-0 transition-opacity duration-300" loading="lazy" onload="this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('hidden');" onerror="this.onerror=null;this.src='https://via.placeholder.com/64?text=No+Img'; this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('hidden');">
                           </div>`
                        : `<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-gray-300 flex-none"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>`;

                    itemDiv.innerHTML = `
                        ${imgHtml}
                        <div class="flex-1 min-w-0">
                            <h5 class="font-bold text-gray-800 truncate">${item.product_name}</h5>
                            <div class="text-xs text-gray-500 mt-1 space-y-1">
                                <p class="truncate">ประเภท : ${item.product_type_name || '-'}</p>
                                <p class="truncate">ไอดีตัวละคร : ${item.customer_game_id || '-'}</p>
                                <p class="truncate">จำนวน : <span class="text-black font-medium">${item.quantity_done}/${item.quantity_total}</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end justify-between shrink-0">
                            <span class="text-xs px-2 py-1 rounded-full border ${statusClass} whitespace-nowrap">
                                ${item.process_status}
                            </span>
                        </div>
                    `;
                    productList.appendChild(itemDiv);
                });
            } else {
                productList.innerHTML = '<div class="text-center text-gray-400 text-sm">ไม่มีรายการสินค้า</div>';
            }

            modal.classList.remove('hidden');
            
            const modalBody = document.getElementById('modal-body');
            if (modalBody) modalBody.scrollTop = 0;

            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            document.body.style.overflow = '';
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // ฟังก์ชันสร้าง Bill ชั่วคราวเพื่อแคปเจอร์
        function captureOrderBill() {
            if (!currentOpenOrder) return;
            
            // 1. Create Hidden Bill Container
            const billContainer = document.createElement('div');
            billContainer.id = 'bill-temp';
            // Set style: width 500px, white background, styling similar to receipt
            billContainer.style.cssText = "position: absolute; top: -9999px; left: -9999px; width: 500px; background: #fff; padding: 30px; font-family: 'Noto Sans Thai', sans-serif; color: #333; border-radius: 10px;";
            
            const gameInfo = getGameInfo(currentOpenOrder.game_id);
            
            // 2. Generate HTML Content
            let itemsHtml = '';
            if (currentOpenOrder.items) {
                currentOpenOrder.items.forEach((item, index) => {
                    // --- LOGIC สีของสถานะในบิล (แก้ไขให้ถูกต้อง) ---
                    let statusStyle = "font-weight: bold; color: #4b5563;"; // Default Gray
                    const s = (item.process_status || "").trim();
                    if (s === "รอคิว" || s === "Queue") statusStyle = "font-weight: bold; color: #c2410c;"; // Orange
                    else if (s === "เริ่มงาน" || s === "In Progress" || s.includes("กำลัง")) statusStyle = "font-weight: bold; color: #1d4ed8;"; // Blue
                    else if (s === "รอส่ง" || s === "Waiting") statusStyle = "font-weight: bold; color: #7e22ce;"; // Purple
                    else if (s === "เรียบร้อยแล้ว" || s === "Completed") statusStyle = "font-weight: bold; color: #15803d;"; // Green

                   // แก้ไข Badge ในบิล: ใช้ white-space: nowrap และ display: inline-block
                   itemsHtml += `
                    <div style="display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 0px 10px 10px 10px;">
                        <div style="width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                             ${item.image_link ? `<img src="${getDriveDirectLink(item.image_link)}" style="width: 100%; height: 100%; object-fit: cover;" crossorigin="anonymous">` : '<span style="color:#ccc; font-size: 10px;">No Img</span>'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 14px; color: #000;">${item.product_name}</div>
                            <div style="font-size: 12px; color: #666;">ประเภท: ${item.product_type_name || '-'}</div>
                            <div style="font-size: 12px; color: #666;">ไอดี: ${item.customer_game_id || '-'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; font-weight: bold; padding: 10px 0px 0px 10px;">x${item.quantity_total}</div>
                            <span style="font-size: 12px; border-radius: 99px; ${statusStyle}">${item.process_status}</span>
                        </div>
                    </div>
                   `; 
                });
            }

            // เพิ่มบรรทัด Total Price และ Discount
            // ต้องตรวจสอบว่า API ส่ง total_price และ discount มาหรือไม่ ถ้าไม่มีจะแสดง 0
            const totalPrice = currentOpenOrder.total_price || 0; // ต้องให้ API ส่งมา
            const discount = currentOpenOrder.discount || 0;     // ต้องให้ API ส่งมา

            // หาก API ยังไม่ได้ส่ง total_price/discount มา (ในเวอร์ชันนี้ยังไม่ได้แก้ Apps Script)
            // เราอาจจะต้องคำนวณหลอกๆ หรือแสดง 0 ไปก่อน หรือใช้ net_price เป็นหลัก
            // เพื่อความสมบูรณ์ตาม Request ผมจะใส่โค้ดแสดงผลไว้ ถ้าข้อมูลมาเมื่อไหร่ก็จะขึ้นครับ

            billContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #000; margin: 0;">ใบสรุปรายการสั่งซื้อ</h2>
                    <div style="font-size: 14px; color: #666;">${formatDate(currentOpenOrder.order_date)}</div>
                </div>
                
                <div style="background: #f9fafb; padding: 0px 15px 15px 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 13px;">เลขที่ออเดอร์</span>
                        <span style="font-weight: bold; font-size: 14px;">${currentOpenOrder.order_id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 13px;">เกม</span>
                        <span style="font-weight: bold; font-size: 14px;">${gameInfo.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 13px;">ลูกค้า</span>
                        <span style="font-weight: bold; font-size: 14px;">${currentOpenOrder.customer_account_id || '-'}</span>
                    </div>
                     <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666; font-size: 13px;">สถานะชำระเงิน</span>
                        <span style="font-weight: bold; font-size: 14px; color: ${currentOpenOrder.payment_status === 'Paid' || currentOpenOrder.payment_status === 'ชำระเงินเรียบร้อย' ? '#15803d' : '#f59e0b'};">${currentOpenOrder.payment_status}</span>
                    </div>
                </div>

                <h3 style="font-size: 16px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 0px;">รายการสินค้า</h3>
                <div>${itemsHtml}</div>

                <div style="margin-top: 20px; padding-top: 5px; border-top: 2px dashed #ddd;">
                    <!-- เพิ่ม ยอดรวม และ ส่วนลด -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 14px; color: #666;">ยอดรวม</span>
                        <span style="font-size: 14px; font-weight: bold;">${formatNumber(totalPrice)} บาท</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 14px; color: #666;">ส่วนลด</span>
                        <span style="font-size: 14px; font-weight: bold; color: #ef4444; margin-bottom: 10px">${formatNumber(discount)} บาท</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #eee;">
                        <span style="font-size: 16px; font-weight: bold;">ยอดรวมสุทธิ</span>
                        <span style="font-size: 24px; font-weight: bold; color: #2563eb;">${formatNumber(currentOpenOrder.net_price)} บาท</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #aaa;">
                    ขอบคุณที่ใช้บริการ
                </div>
            `;

            document.body.appendChild(billContainer);

            // 3. Capture
            // Hide buttons temporarily
            const closeBtn = document.getElementById('close-modal-btn');
            const capBtn = document.getElementById('capture-btn');
            
            // Start Capture
            html2canvas(billContainer, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `Bill-${currentOpenOrder.order_id}.png`;
                link.click();
                
                // Clean up
                document.body.removeChild(billContainer);
            }).catch(err => {
                console.error("Capture failed", err);
                showToast("เกิดข้อผิดพลาดในการบันทึกภาพ");
                if(document.body.contains(billContainer)) {
                    document.body.removeChild(billContainer);
                }
            });
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        closeModalBtn.addEventListener('click', closeModal);
        captureBtn.addEventListener('click', captureOrderBill);

        fetchData();
    </script>
</body>
</html>
